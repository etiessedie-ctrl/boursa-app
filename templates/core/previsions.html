{% extends "base.html" %}

{% block title %}BoursA - Prévisions ML{% endblock %}

{% block head_extra %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
    .step-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    .step-active {
        border-left-color: #f59e0b; /* amber-500 for ML */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #f59e0b;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 10px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    /* Styles pour la validation */
    .invalid {
        border-color: #dc2626 !important; /* red-600 */
        box-shadow: 0 0 0 1px #dc2626 !important;
    }
    .error-message {
        animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    /* Styles pour les boutons d'import sélectionnés */
    .import-button-selected {
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3) !important;
        transform: scale(1.02);
    }
    .import-button-selected.api-selected {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6">
    <a href="{% url 'core:accueil' %}" class="text-blue-500 hover:text-blue-700 flex items-center mb-6">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Retour à l'accueil
    </a>

    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Générer une Prévision ML</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Colonne de navigation (Étapes) -->
        <div class="lg:col-span-1 space-y-4">
            <div id="step-1-card" class="step-card bg-white p-6 rounded-lg shadow step-active">
                <h2 class="text-xl font-semibold text-gray-800">Étape 1: Importation des Données</h2>
                <p class="text-sm text-gray-500">Téléchargez votre fichier CSV ou Excel.</p>
            </div>
            <div id="step-2-card" class="step-card bg-white p-6 rounded-lg shadow opacity-50">
                <h2 class="text-xl font-semibold text-gray-800">Étape 2: Sélection du Modèle et Paramètres</h2>
                <p class="text-sm text-gray-500">Choisissez le modèle et configurez la prévision.</p>
            </div>
            <div id="step-3-card" class="step-card bg-white p-6 rounded-lg shadow opacity-50">
                <h2 class="text-xl font-semibold text-gray-800">Étape 3: Résultats de la Prévision</h2>
                <p class="text-sm text-gray-500">Visualisez le graphique et les résultats.</p>
            </div>
        </div>

        <!-- Colonne de contenu (Formulaires) -->
        <div class="lg:col-span-2">
            <!-- Étape 1: Importation des Données -->
            <div id="step-1-content" class="bg-white p-8 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">1. Choisir le mode d'import</h2>

                <div class="mb-6 flex flex-col gap-3">
                    <button id="choose-local" type="button" class="w-full px-5 py-4 border-2 rounded-lg font-semibold bg-white hover:bg-green-50 focus:ring-2 focus:ring-green-500 text-left shadow-sm flex items-center gap-3">
                        <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-green-100 text-green-700 font-bold">A</span>
                        <div>
                            <div class="text-lg">Importer un fichier local</div>
                            <div class="text-sm text-gray-500">CSV / Excel depuis votre ordinateur</div>
                        </div>
                    </button>
                    <button id="choose-api" type="button" class="w-full px-5 py-4 border-2 rounded-lg font-semibold bg-white hover:bg-blue-50 focus:ring-2 focus:ring-blue-500 text-left shadow-sm flex items-center gap-3">
                        <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-blue-100 text-blue-700 font-bold">B</span>
                        <div>
                            <div class="text-lg">Importer via API boursière</div>
                            <div class="text-sm text-gray-500">Yahoo Finance ou Alpha Vantage</div>
                        </div>
                    </button>
                </div>

                <div id="import-local-panel" class="p-4 border rounded-lg bg-gray-50 hidden">
                    <p class="font-semibold mb-2">Option : Fichier local</p>
                    <form id="upload-form" method="POST" action="{% url 'core:upload_file' %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="data_file">
                            Fichier de données (CSV, Excel)
                        </label>
                        <input type="file" name="data_file" id="data_file"
                               accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
                               class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 mb-3">
                        <p class="text-xs text-gray-500 mt-1 mb-3">Formats acceptés : CSV, XLSX, XLS (max 16 MB)</p>
                        <button type="submit" id="upload-button" class="bg-green-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-green-700 transition w-full">
                            Analyser le fichier
                        </button>
                    </form>
                </div>

                <div id="import-api-panel" class="p-4 border rounded-lg bg-gray-50 hidden">
                    <p class="font-semibold mb-2">Option : API boursière</p>
                    <form id="api-fetch-form">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="api_source">Source</label>
                        <select id="api_source" name="source" class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3">
                            <option value="">Choisir...</option>
                            <option value="yahoo">Yahoo Finance (gratuit, pas de clé requise)</option>
                            <option value="alpha_vantage">Alpha Vantage (gratuit, clé requise)</option>
                            <option value="iex_cloud">IEX Cloud (gratuit, clé requise)</option>
                            <option value="polygon">Polygon.io (gratuit/freemium, clé requise)</option>
                        </select>

                        <label class="block text-gray-700 text-sm font-bold mb-2" for="api_symbol">Ticker (ex: AAPL, BTC-USD)</label>
                        <input type="text" id="api_symbol" name="symbol" placeholder="AAPL" class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3">

                        <label class="block text-gray-700 text-sm font-bold mb-2" for="api_key">Clé API (Alpha Vantage / IEX Cloud)</label>
                        <input type="text" id="api_key" name="api_key" placeholder="Optionnel si la clé est définie dans .env" class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">

                        <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-blue-700 transition w-full">
                            Importer via API
                        </button>
                        <p class="text-xs text-gray-500 mt-2">Yahoo: 1d/1h/5m/1wk/1mo. Alpha Vantage: daily/weekly/monthly. IEX Cloud: 1d/1w/1mo. Polygon: daily.</p>
                    </form>
                </div>
            </div>

            <!-- Étape 2: Sélection du Modèle et Paramètres (Initialement caché) -->
            <div id="step-2-content" class="bg-white p-8 rounded-lg shadow-xl mt-8 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">2. Sélectionner le Modèle et les Paramètres</h2>
                    <button id="back-to-step-1-button" type="button" class="text-sm text-blue-600 hover:text-blue-800 flex items-center transition">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Changer de fichier
                    </button>
                </div>

                <!-- Affichage des données -->
                <div class="mb-6 p-4 bg-gray-50 border rounded-lg">
                    <h3 class="text-xl font-semibold mb-3">Aperçu des données (<span id="filename-display" class="text-blue-600"></span>)</h3>
                    <p class="text-sm text-gray-600 mb-2">Colonnes détectées : <span id="columns-list" class="font-mono text-xs"></span></p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr id="data-header"></tr>
                            </thead>
                            <tbody id="data-preview" class="bg-white divide-y divide-gray-200">
                                <!-- Les 5 premières lignes seront insérées ici -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <form id="forecast-form" method="POST" action="{% url 'core:handle_forecast_request' %}">
                    {% csrf_token %}
                    <!-- Sélection du Modèle -->
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="selected_model">
                            Sélectionner le Modèle de Prévision
                        </label>
                        <select name="selected_model" id="selected_model" required
                                class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="">-- Choisir un modèle --</option>
                            <optgroup label="Modèles Pré-entraînés">
                                <option value="random_forest">Random Forest (pré-entraîné)</option>
                                <option value="xgboost">XGBoost (pré-entraîné)</option>
                            </optgroup>
                            <optgroup label="Modèles de Régression">
                                <option value="linear_regression">Régression Linéaire</option>
                            </optgroup>
                            <optgroup label="Modèles de Séries Temporelles">
                                <option value="arima">ARIMA</option>
                                <option value="sarima">SARIMA</option>
                                <option value="prophet">Facebook Prophet</option>
                                <option value="lstm">LSTM</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Sélection de la Colonne Cible -->
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            Sélectionner la Colonne Cible (à prévoir)
                        </label>
                        <div id="target-column-selection" class="space-y-2 p-4 border rounded-lg bg-white">
                            <p class="text-gray-500">Les options de colonnes apparaîtront ici après l'analyse du fichier.</p>
                        </div>
                    </div>

                    <!-- Paramètres de Prévision -->
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="forecast_steps">
                            Nombre de périodes à prévoir
                        </label>
                        <input type="number" name="forecast_steps" id="forecast_steps" min="1" max="100" value="5"
                               class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <p class="text-xs text-gray-500 mt-1">Nombre de points de données à prévoir (1-100)</p>
                    </div>

                    <button type="submit" id="run-forecast-button" class="bg-amber-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-amber-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Générer la Prévision
                    </button>
                </form>
            </div>

            <!-- Étape 3: Résultats (Initialement caché) -->
            <div id="step-3-content" class="bg-white p-8 rounded-lg shadow-xl mt-8 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">3. Résultats de la Prévision</h2>
                    <button id="back-to-step-2-button" type="button" class="text-sm text-blue-600 hover:text-blue-800 flex items-center transition">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Modifier la sélection
                    </button>
                </div>

                <!-- Affichage des résultats -->
                <div id="results-container" class="space-y-6">
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-amber-800 mb-4">Prévision générée avec succès !</h3>
                        <div id="forecast-results" class="space-y-3">
                            <!-- Les résultats seront insérés ici par JavaScript -->
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="flex space-x-4">
                        <a href="{% url 'core:historiques' %}" class="bg-amber-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-amber-700 transition">
                            Voir l'historique des prévisions
                        </a>
                        <button id="export-forecast-button" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                            Exporter les résultats
                        </button>
                        <button id="new-forecast-button" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition">
                            Nouvelle prévision
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script id="previsions-bootstrap" type="application/json">
{{ bootstrap_json|safe }}
</script>

<script>
    // ÉTAT GLOBAL DE L'APPLICATION
    let global_columns = JSON.parse('{{ file_columns | tojson | safe }}');
    let global_filename = '{{ current_file }}';
    let global_dtypes = JSON.parse('{{ file_dtypes | tojson | safe }}');
    let global_preview = [];
    let importMode = null;

    // FONCTIONS UTILITAIRES

    function updateStep(step) {
        // Mise à jour visuelle des cartes d'étapes
        $('#step-1-card').removeClass('step-active opacity-50').addClass(step === 1 ? 'step-active' : 'opacity-50');
        $('#step-2-card').removeClass('step-active opacity-50').addClass(step === 2 ? 'step-active' : 'opacity-50');
        $('#step-3-card').removeClass('step-active opacity-50').addClass(step === 3 ? 'step-active' : 'opacity-50');

        // Affichage conditionnel du contenu
        $('#step-1-content').toggle(step === 1);
        $('#step-2-content').toggle(step === 2);
        $('#step-3-content').toggle(step === 3);
    }

    function generateTargetColumnOptions(columns) {
        let html = '';
        columns.forEach(col => {
            const dtype = global_dtypes[col] || 'inconnu';
            html += `
                <label class="inline-flex items-center mr-4 mb-2 cursor-pointer hover:bg-gray-50 p-2 rounded transition">
                    <input type="radio" name="target_column" value="${col}" class="form-radio h-5 w-5 text-amber-600 rounded">
                    <span class="ml-2 text-gray-700">${col} <span class="text-xs text-gray-500">(${dtype})</span></span>
                </label>
            `;
        });
        $('#target-column-selection').html(html);
    }

    function loadInitialState() {
        // Toujours commencer par l'étape 1 (choix du mode), mais préremplir si des données existent
        updateStep(1);
        $('#back-to-step-1-button').hide();

        if (global_filename && global_columns && global_columns.length > 0) {
            $('#filename-display').text(global_filename);

            let columnsListHtml = '';
            global_columns.forEach(col => {
                const dtype = global_dtypes[col] || 'inconnu';
                columnsListHtml += '<span class="bg-gray-200 p-1 rounded mr-2">' + col + ' (' + dtype + ')</span>';
            });
            $('#columns-list').html(columnsListHtml);

            let headerHtml = '';
            global_columns.forEach(col => {
                headerHtml += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">' + col + '</th>';
            });
            $('#data-header').html(headerHtml);

            $('#data-preview').html(
                '<tr><td colspan="' + global_columns.length + '" class="text-center py-4 text-gray-500">Aperçu non disponible (fichier chargé précédemment). Uploadez à nouveau pour voir les données.</td></tr>'
            );

            generateTargetColumnOptions(global_columns);
        }
    }

    // GESTION DES ÉVÉNEMENTS

    // Bouton "Changer de fichier" - Retour à l'étape 1
    $('#back-to-step-1-button').on('click', function() {
        const btn = $(this);
        btn.prop('disabled', true).html('Réinitialisation...');

        $.ajax({
            url: '{% url "core:clear_session_file" %}',
            type: 'POST',
            success: function() {
                // Réinitialisation de l'état global
                global_filename = '';
                global_columns = [];
                global_dtypes = {};
                global_preview = [];

                // Réinitialisation du formulaire
                $('#forecast-form')[0].reset();
                $('#run-forecast-button').prop('disabled', true);

                // Retour à l'étape 1
                updateStep(1);
                $('#back-to-step-1-button').hide();
            },
            error: function(xhr, status, error) {
                alert('Erreur lors de la réinitialisation: ' + error);
                btn.prop('disabled', false).html('Changer de fichier');
            }
        });
    });

    // Sélection du mode d'import
    function selectImportMode(mode) {
        importMode = mode;
        $('#import-local-panel').toggle(mode === 'local');
        $('#import-api-panel').toggle(mode === 'api');
        $('#data_file').prop('required', mode === 'local');
        $('#api_source, #api_symbol').prop('required', mode === 'api');
        $('#choose-local').toggleClass('bg-green-50 border-green-400', mode === 'local');
        $('#choose-api').toggleClass('bg-blue-50 border-blue-400', mode === 'api');
    }

    $('#choose-local').on('click', function() { selectImportMode('local'); });
    $('#choose-api').on('click', function() { selectImportMode('api'); });

    function hydrateDataPreview(response) {
        global_columns = response.columns;
        global_filename = response.filename;
        global_dtypes = response.dtypes;
        global_preview = response.preview || [];

        $('#filename-display').text(global_filename);

        let columnsListHtml = '';
        global_columns.forEach(col => {
            const dtype = global_dtypes[col] || 'inconnu';
            columnsListHtml += '<span class="bg-gray-200 p-1 rounded mr-2">' + col + ' (' + dtype + ')</span>';
        });
        $('#columns-list').html(columnsListHtml);

        let headerHtml = '';
        global_columns.forEach(col => {
            headerHtml += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">' + col + '</th>';
        });
        $('#data-header').html(headerHtml);

        let bodyHtml = '';
        if (response.preview) {
            response.preview.forEach(row => {
                bodyHtml += '<tr>';
                row.forEach(cell => {
                    bodyHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">' + cell + '</td>';
                });
                bodyHtml += '</tr>';
            });
        }
        $('#data-preview').html(bodyHtml || '<tr><td colspan="' + global_columns.length + '" class="text-center py-4 text-gray-500">Aperçu non disponible.</td></tr>');

        generateTargetColumnOptions(global_columns);
        updateStep(2);
        $('#back-to-step-1-button').show();
        $('#step-2-content')[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Fonction pour obtenir le token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Soumission du formulaire d'upload
    $('#upload-form').on('submit', function(e) {
        e.preventDefault();
        if (importMode !== 'local') {
            alert('Choisissez d\'abord le mode "Fichier local".');
            return;
        }
        const formData = new FormData(this);
        const button = $('#upload-button');

        // Récupérer le token CSRF (depuis le formulaire ou les cookies)
        const csrftoken = $('[name=csrfmiddlewaretoken]').val() || getCookie('csrftoken');

        // Indicateur de chargement
        button.prop('disabled', true).html('Analyse en cours... <span class="loading-spinner"></span>');

        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: csrftoken ? {'X-CSRFToken': csrftoken} : {},
            success: function(response) {
                if (response.success) {
                    hydrateDataPreview(response);
                } else {
                    alert('Erreur: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                let errorMsg = 'Erreur lors de l\'upload: ';
                if (xhr.status === 403) {
                    errorMsg += 'Accès refusé (CSRF). Veuillez rafraîchir la page et réessayer.';
                } else if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg += xhr.responseJSON.message;
                } else {
                    errorMsg += error;
                }
                alert(errorMsg);
            },
            complete: function() {
                button.prop('disabled', false).html('Analyser le fichier');
            }
        });
    });

    // Changement de modèle sélectionné
    $('#selected_model').on('change', function() {
        const selectedModel = $(this).val();
        const runButton = $('#run-forecast-button');

        if (selectedModel) {
            runButton.prop('disabled', false).text('Générer la Prévision');
        } else {
            runButton.prop('disabled', true).text('Sélectionnez un modèle');
        }
    });

    // Changement de sélection de la colonne cible
    $(document).on('change', 'input[name="target_column"]', function() {
        const selectedTarget = $('input[name="target_column"]:checked').val();
        const runButton = $('#run-forecast-button');

        if (selectedTarget && $('#selected_model').val()) {
            runButton.prop('disabled', false).text('Générer la Prévision');
        } else {
            runButton.prop('disabled', true).text('Sélectionnez modèle et colonne cible');
        }
    });

    // Soumission du formulaire de prévision
    $('#forecast-form').on('submit', function(e) {
        e.preventDefault();

        const selectedModel = $('#selected_model').val();
        const selectedTarget = $('input[name="target_column"]:checked').val();
        const forecastSteps = $('#forecast_steps').val();

        if (!selectedModel || !selectedTarget) {
            alert('Veuillez sélectionner un modèle et une colonne cible.');
            return false;
        }

        // Préparer les données pour l'envoi AJAX
        const forecastData = {
            selected_model: selectedModel,
            target_column: selectedTarget,
            forecast_steps: forecastSteps,
            filename: global_filename,  // Ajouter le nom du fichier
            ajax: 'true'  // Indiquer que c'est une requête AJAX
        };

        // Récupérer le token CSRF
        const csrftoken = $('[name=csrfmiddlewaretoken]').val() || getCookie('csrftoken');

        const runButton = $('#run-forecast-button');
        runButton.prop('disabled', true).text('Génération en cours...');

        // Envoyer via AJAX
        $.ajax({
            url: '{% url "core:handle_forecast_request" %}',
            type: 'POST',
            data: forecastData,  // Envoyer comme données de formulaire, pas JSON
            headers: csrftoken ? {'X-CSRFToken': csrftoken} : {},
            success: function(response) {
                if (response.success) {
                    // Générer l'affichage des résultats avec les vraies données
                    let resultsHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-white p-4 rounded-lg border">
                                <h4 class="font-semibold text-gray-800">Informations générales</h4>
                                <p><strong>Modèle:</strong> ${response.model}</p>
                                <p><strong>Colonne cible:</strong> ${response.target_column}</p>
                                <p><strong>Périodes à prévoir:</strong> ${response.steps}</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <h4 class="font-semibold text-gray-800">Résultats de la prévision</h4>
                                <p><strong>Statut:</strong> Prévision générée avec succès</p>
                                <p><strong>Algorithme:</strong> ${response.model}</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800">Graphique de prévision</h4>
                            <img src="data:image/png;base64,${response.forecast_plot}" alt="Graphique des prévisions" class="w-full h-auto">
                        </div>
                        <div class="bg-white p-4 rounded-lg border mt-4">
                            <h4 class="font-semibold text-gray-800">Tableau des prévisions</h4>
                            <div class="overflow-x-auto">
                                ${response.forecast_results}
                            </div>
                        </div>
                    `;

                    $('#forecast-results').html(resultsHtml);
                    updateStep(3);
                    $('#step-3-content')[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    alert('Erreur: ' + (response.message || 'Erreur inconnue'));
                }
            },
            error: function(xhr, status, error) {
                let errorMsg = 'Erreur lors de la génération de la prévision: ';
                if (xhr.status === 403) {
                    errorMsg += 'Accès refusé (CSRF). Veuillez rafraîchir la page et réessayer.';
                } else if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg += xhr.responseJSON.message;
                } else {
                    errorMsg += error;
                }
                alert(errorMsg);
            },
            complete: function() {
                runButton.prop('disabled', false).text('Générer la Prévision');
            }
        });
    });

    // Import API: interval removed (no dynamic interval selection)

    $('#api-fetch-form').on('submit', function(e) {
        e.preventDefault();
        if (importMode !== 'api') {
            alert('Sélectionnez le mode "API boursière" pour cette action.');
            return;
        }
        const button = $('#api-fetch-form button[type="submit"]');
        button.prop('disabled', true).text('Import en cours...');

        const payload = {
            source: $('#api_source').val(),
            symbol: $('#api_symbol').val(),
            api_key: $('#api_key').val() || null
        };

        $.ajax({
            url: '{% url "core:api_fetch" %}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(response) {
                button.prop('disabled', false).text('Importer via API');
                if (response.success) {
                    hydrateDataPreview(response);
                } else {
                    alert(response.message || 'Erreur lors de l\'import API.');
                }
            },
            error: function() {
                button.prop('disabled', false).text('Importer via API');
                alert('Erreur lors de l\'import API. Veuillez réessayer.');
            }
        });
    });

    // Bouton "Modifier la sélection" - Retour à l'étape 2
    $('#back-to-step-2-button').on('click', function() {
        updateStep(2);
        $('#step-2-content')[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Bouton "Nouvelle prévision" - Retour à l'étape 2 et réinitialisation
    $('#new-forecast-button').on('click', function() {
        $('#forecast-form')[0].reset();
        $('#run-forecast-button').prop('disabled', true);
        updateStep(2);
        $('#step-2-content')[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Bouton "Exporter les résultats" - Fonctionnalité basique
    $('#export-forecast-button').on('click', function() {
        const resultsText = $('#forecast-results').text();
        const blob = new Blob([resultsText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'resultats_prevision.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    // Initialisation
    $(document).ready(function() {
        loadInitialState();
    });
</script>

{% endblock %}

